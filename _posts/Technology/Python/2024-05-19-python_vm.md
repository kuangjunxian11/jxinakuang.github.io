---

layout: post
title: Python虚拟机
category: 技术
tags: Python
keywords: Python

---

* TOC
{:toc}


## 简介

## 虚拟机

Python 虚拟机设计了一种基于栈的字节码，执行过程简洁高效。Python 语言既支持面向对象编程，也支持将函数做为语言的第一类公民，支持自动内存管理。支持语言的动态特性，例如运行时修改类定义、反射等。

编程语言虚拟机的一个重要能力就是屏蔽硬件差异。
1. 以 Java 为例，Java 源代码文件会被 javac 先编译生成 class 文件，多个 class 文件可以集中在一起，生成一个 jar 文件。字节码的设计非常类似于 CPU 指令，它有自己定义的数值计算、位操作、比较操作、跳转操作等。所以人们把这种专门为某一类编程语言所开发的字节码以及其解释器合并称为编程语言虚拟机。
2. 以 V8 为代表的 JavaScript 虚拟机。网页上的 JS 代码都是以源代码的形式由服务端发送到客户端，然后客户端来执行的。相比 Java 的执行过程，这一过程中缺少了编译生成字节码的步骤。它根本不需要生成字节码，而是直接将源代码翻译成树形结构，我们称之为抽象语法树。然后，V8 的执行器就通过后序遍历这棵树，在访问语法树上的不同结点时，执行与这个结点相对应的动作，最终完成代码的解释执行。这种做法是把源代码的编译和程序的执行直接绑定在一起。
3. 以 Go 为代表的静态编译的类型。如果对 Go 语言的源代码进行编译的话，你会发现，即使是很小的一段代码，编译的可执行程序的体积也会很大，这是因为 Go 在编译的时候直接将虚拟机与用户代码链接在了一起。好处是，既能通过虚拟机实现对硬件平台和操作系统的屏蔽，又能提供很好的执行效率。
4. Python 比较灵活，一方面它规定了自己的字节码，但它又不要求程序必须以字节码文件（.pyc）来发布。它完全支持甚至鼓励应用程序以源代码的方式发行。本质上，在 Python 虚拟机内部，源代码也是先编译成字节码然后再执行的，也就是说 Python 的编译器 Python 虚拟机的一部分，它不像 Java 虚拟机，javac 用于编译，和执行是分离的。你可以回忆一下 Python 中的 eval 功能，其实 eval 就是调用了 Python 内置的编译器，来编译字符串。CPython 虚拟机既可以执行 py 文件，也可以执行编译过的 pyc 文件，这是因为**CPython 里包含了一个可以编译 py 文件的编译器**，在执行 py 文件时，第一步就是要把 py 文件先翻译成字节码文件。当然 Python 虚拟机也有其他的开源实现，例如，Jython 是一种用 Java 实现的 Python 语言，它的原理与 CPython 大有不同，它放弃了 Python 的原生字节码，直接将 py 源代码文件翻译成了由 Java 字节码组成的 class 文件。而我们知道，class 文件是可以直接在 Java 虚拟机上执行的，这样一来，Python 代码就可以自由地使用各种强大的 Java 类库。通过编译，Jython 实现了 Python 与 Java 的无缝衔接。

编程语言的发展为虚拟机技术提供了源动力，而虚拟机技术的发展则为编程语言的发展提供了根本保障。虚拟机中的很多技术是为了支持对应的语言特性才被发明出来的，同样有很多好用的语言特性也是因为虚拟机技术的长足发展才得以实现。所以说，编程语言和虚拟机技术是相互依赖和对立统一的。

## 内存管理

垃圾回收可以分为引用计数和 Tracing GC 两大类，其中引用计数的代表就是 CPython，也就是我们平常最常使用的社区版 Python。而大多数编程语言虚拟机基本上都使用 Tracing GC。